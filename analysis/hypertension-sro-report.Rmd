---
title: "QOF - Hypertension"
subtitle: "Indicators: HYP001 (Register)"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
---

```{r setup, include=FALSE}
# Set Rmd options ----
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE)

# Load packages ----
library(ggplot2)
library(magrittr)
library(dplyr)
library(tidyr)
library(here)
library(knitr)
library(readr)
library(fs)
library(purrr)
library(stringr)
library(gt)
library(ggrepel)
library(fs)

# Load plotting function
source(here::here("lib", "functions", "fun_plot.R"))

# Create directory if it doesnt exist
fs::dir_create(here::here("output", "notebooks"))
```

```{r load-data, include=FALSE}
# Get file names and path ----
df_measures_hyp001 <- readr::read_csv(here::here("output", "measures", "measures_hyp001.csv"))
list_nhs_financial_years <- unique(df_measures_hyp001$date[lubridate::month(df_measures_hyp001$date) == 4])

```
# Introduction

## What it is 

The [Quality and Outcomes Framework (QOF)](https://digital.nhs.uk/data-and-information/data-tools-and-services/data-services/general-practice-data-hub/quality-outcomes-framework-qof) outlines three indicator that focus on hypertension (HYP001, HYP003, and HYP007). 
We aim to use OpenSAFELY to quantify the extent to which the hypertension indicators were disrupted during the pandemic.

## Why it matters

General practice has been disrupted by the pandemic in many clinical areas (e.g., [Curtis et al., 2021](https://bjgp.org/content/72/714/e63); [Williamson et al., 2020](https://www.nature.com/articles/s41586-020-2521-4)). 
We aim to assess the impact of the pandemic on the routine management of blood pressure. 
High blood pressure is one of the leading risk factors for several diseases (e.g., cardiovascular disease, stroke) worldwide. 
Research suggests that delays in the management of high blood pressure are associated with worse clinical outcomes, for example acute cardiovascular events, or death ([Xu et al., 2015](https://www.bmj.com/content/350/bmj.h158)).

# Methods

Using OpenSAFELY-TPP, covering 40% of England's population, we have evaluated the QOF Hypertension indicators (HYP001, HYP003, HYP007) between 2019-09-01 and 2022-03-31.
The codelist used can be found here at [OpenSAFELY Codelists](https://codelists.opensafely.org/).

The **study population** for the register was defined following the business rules the (v46).
For each month within the study period, we have calculated the percentage of registered patients with a diagnosis of hypertension which has not been subsequently resolved.
All analytical code and output is available for inspection at the [OpenSAFELY GitHub repository](https://github.com/opensafely/hypertension-sro).

## Business rules

More details about the rules can be found [here](https://digital.nhs.uk/data-and-information/data-collections-and-data-sets/data-collections/quality-and-outcomes-framework-qof/quality-and-outcome-framework-qof-business-rules/qof-business-rules-v46.0-2021-2022-baseline-release).
Dashboards presenting the annual targets of all QOF indicators published by NHSD are available [here](https://digital.nhs.uk/data-and-information/data-tools-and-services/data-services/general-practice-data-hub/quality-outcomes-framework-qof).

### HYP001 (Register)

The rules for the Hypertension Register (HYP001, Version: 46.0) are outlined below:

> "Select patients from the specified population who have a diagnosis of hypertension which has not been subsequently resolved."

### HYP003

- TODO

### HYP007

- TODO

# Results

Note that the scaling of the y-axis is different for the total population (0 to 100%) and outputs by subgroup (scaling differs across grouping variables to highlight differences between groups).

## HYP001 (Register)

### HYP001 total population

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
    dplyr::filter(group == "population") %>% 
    plot_qof_indicator(legend = "none", plotly = FALSE, 
                       set_y_scale_limits = TRUE)

```

```{r fig.width=8, fig.height=4}
df_measures_hyp001 %>%
    dplyr::filter(group == "population") %>% 
    ggplot2::ggplot(ggplot2::aes(date, hypertension, colour = category)) +
    ggplot2::geom_line(size = 1,
                       alpha = 0.3) +
    ggplot2::geom_point(size = 2) +
    ggplot2::scale_x_date(date_breaks = "4 month",
                          date_labels = "%b %y") +
    # ggplot2::facet_wrap(~category, ncol = 2) +
    ggplot2::theme(text = ggplot2::element_text(size = 14)) +
    ggplot2::theme(legend.position = "none") +
    ggplot2::expand_limits(y = 0) +
    ggplot2::labs(x = NULL, y = "Count") +
    ggplot2::scale_colour_viridis_d() +
    geom_segment(aes(xend=date, yend=0), size = 2, alpha = 0.5) +
    ggplot2::geom_vline(xintercept = lubridate::as_date(list_nhs_financial_years),
                          linetype = "dotted",
                          colour = "orange",
                          size = 1)
```

### HYP001 by sex

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "sex") %>% 
  dplyr::mutate(category = factor(category,
                                  levels = c("F", "M"),
                                  labels = c("Female", "Male"))) %>% 
  plot_qof_indicator(plotly = FALSE) +
  scale_colour_brewer(palette = "Dark2")

```

```{r fig.width=8, fig.height=4}
df_measures_hyp001 %>%
    dplyr::filter(group == "sex") %>%
  dplyr::mutate(category = factor(category,
                                  levels = c("F", "M"),
                                  labels = c("Female", "Male"))) %>% 
    ggplot2::ggplot(ggplot2::aes(date, hypertension, colour = category)) +
    ggplot2::geom_line(size = 1,
                       alpha = 0.3) +
    ggplot2::geom_point(size = 2) +
    ggplot2::scale_x_date(date_breaks = "4 month",
                          date_labels = "%b %y") +
    # ggplot2::facet_wrap(~category, ncol = 2) +
    ggplot2::theme(text = ggplot2::element_text(size = 14)) +
    ggplot2::scale_colour_brewer(palette = "Dark2") +
    ggplot2::theme(legend.position = "top") +
    ggplot2::expand_limits(y = 0) +
    ggplot2::labs(x = NULL, y = "Count", colour = NULL) +
    ggplot2::geom_vline(xintercept = lubridate::as_date(list_nhs_financial_years),
                          linetype = "dotted",
                          colour = "orange",
                          size = 1)
```

### HYP001 by age band

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "age_band") %>% 
  dplyr::filter(category != "missing") %>% 
  plot_qof_indicator(plotly = FALSE)

```

```{r fig.width=8, fig.height=4}
df_measures_hyp001 %>%
    dplyr::filter(group == "age_band") %>%
    dplyr::filter(category != "missing") %>%
    ggplot2::ggplot(ggplot2::aes(date, hypertension, colour = category)) +
    ggplot2::geom_line(size = 1,
                       alpha = 0.3) +
    ggplot2::geom_point(size = 2) +
    ggplot2::scale_x_date(date_breaks = "4 month",
                          date_labels = "%b %y") +
    # ggplot2::facet_wrap(~category, ncol = 2) +
    ggplot2::theme(text = ggplot2::element_text(size = 14)) +
    ggplot2::scale_colour_viridis_d() +
    ggplot2::theme(legend.position = "top") +
    ggplot2::expand_limits(y = 0) +
    ggplot2::labs(x = NULL, y = "Count", colour = NULL) +
    ggplot2::geom_vline(xintercept = lubridate::as_date(list_nhs_financial_years),
                          linetype = "dotted",
                          colour = "orange",
                          size = 1)

```

### HYP001 by IMD

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "imd") %>%
  dplyr::mutate(category = factor(category,
                                  levels = c(1:5),
                                  labels = c('1 - Most deprived', '2', '3', '4', '5 - Least deprived'))) %>% 
  # Remove missing IMD, previously coded as 0
  dplyr::filter(!is.na(category)) %>% 
  plot_qof_indicator(plotly = FALSE)
```


```{r fig.width=8, fig.height=4}
df_measures_hyp001 %>%
  dplyr::filter(group == "imd") %>%
  dplyr::mutate(category = factor(category,
                                  levels = c(1:5),
                                  labels = c('1 - Most deprived', '2', '3', '4', '5 - Least deprived'))) %>% 
    dplyr::filter(!is.na(category)) %>% 
    ggplot2::ggplot(ggplot2::aes(date, hypertension, colour = category)) +
    ggplot2::geom_line(size = 1,
                       alpha = 0.3) +
    ggplot2::geom_point(size = 2) +
    ggplot2::scale_x_date(date_breaks = "4 month",
                          date_labels = "%b %y") +
    # ggplot2::facet_wrap(~category, ncol = 2) +
    ggplot2::theme(text = ggplot2::element_text(size = 14)) +
    ggplot2::scale_colour_viridis_d() +
    ggplot2::theme(legend.position = "top") +
    ggplot2::expand_limits(y = 0) +
    ggplot2::labs(x = NULL, y = "Count", colour = NULL) +
    ggplot2::geom_vline(xintercept = lubridate::as_date(list_nhs_financial_years),
                          linetype = "dotted",
                          colour = "orange",
                          size = 1)
```

### HYP001 by region

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "region") %>% 
  plot_qof_indicator(plotly = FALSE, show_label = FALSE) +
  scale_colour_brewer(palette = "Set1")

```

```{r fig.width=8, fig.height=4}
df_measures_hyp001 %>%
    dplyr::filter(group == "region") %>% 
    ggplot2::ggplot(ggplot2::aes(date, hypertension, colour = category)) +
    ggplot2::geom_line(size = 1,
                       alpha = 0.3) +
    ggplot2::geom_point(size = 2) +
    ggplot2::scale_x_date(date_breaks = "4 month",
                          date_labels = "%b %y") +
    # ggplot2::facet_wrap(~category, ncol = 2) +
    ggplot2::theme(text = ggplot2::element_text(size = 14)) +
    ggplot2::scale_colour_brewer(palette = "Set1") +
    ggplot2::theme(legend.position = "top") +
    ggplot2::expand_limits(y = 0) +
    ggplot2::labs(x = NULL, y = "Count", colour = NULL) +
    ggplot2::geom_vline(xintercept = lubridate::as_date(list_nhs_financial_years),
                          linetype = "dotted",
                          colour = "orange",
                          size = 1)
```

### HYP001 by ethnicity

- TODO

### HYP001 by learning disability

- TODO

### HYP001 by NHS care home status

- TODO

## HYP003

- TODO

## HYP007

- TODO

# Discussion

- TODO

# References 

1. Curtis HJ, MacKenna B, Croker R, Inglesby P, Walker AJ, Morley J, et al. OpenSAFELY NHS Service Restoration Observatory 1: describing trends and variation in primary care clinical activity for 23.3 million patients in England during the first wave of COVID-19. Br J Gen Pract [Internet]. 2021 Sep 20 [cited 2021 Oct 5]; Available from: https://bjgp.org/content/early/2021/09/24/BJGP.2021.0380
1. Williamson EJ, Walker AJ, Bhaskaran K, Bacon S, Bates C, Morton CE, et al. Factors associated with COVID-19-related death using OpenSAFELY. Nature. 2020 Aug;584(7821):430–6. https://www.nature.com/articles/s41586-020-2521-4
1. Xu W, Goldberg SI, Shubina M, Turchin A. Optimal systolic blood pressure target, time to intensification, and time to follow-up in treatment of hypertension: population based retrospective cohort study. BMJ. 2015 Feb 5;350:h158. https://www.bmj.com/content/350/bmj.h158
