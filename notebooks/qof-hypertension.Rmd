---
title: "QOF - Hypertension"
subtitle: "Indicators: HYP001 (Register)"
bibliography: references.bib
link-citations: true
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
---

```{r setup, include=FALSE}
# Set Rmd options ----
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Load packages ----
library(ggplot2)
library(magrittr)
library(dplyr)
library(tidyr)
library(here)
library(knitr)
library(readr)
library(purrr)
library(stringr)
library(patchwork)

# Load plotting function
source(here::here("lib", "functions", "fun_plot.R"))
```

```{r load-data, include=FALSE}
# Set file path and load data ----
# Set file path (path starting with output runs summy data)
path_measures_hyp001 <- here::here("released_outputs", "measures", "measures_hyp001.csv")
# path_measures_hyp001 <- here::here("output", "measures", "measures_hyp001.csv")

# Load data
df_measures_hyp001 <- readr::read_csv(path_measures_hyp001)
```

# Introduction

> *The Quality and Outcomes Framework (QOF) is a voluntary annual reward and incentive programme for all GP practices in England* [@NHSDigital2021b].
> *The objective of the Quality and Outcomes Framework (QOF) is to improve the quality of care patients are given by rewarding practices for the quality of care they provide to their patients, based on a number of indicators across a range of key areas of clinical care and public health.*
> *QOF participation by GP practices is very high, with 96.7% of practices participating in the 2020/21 publication* [@NHSDigital2021a].

OpenSAFELY is a secure analytics platform for electronic patient records built by our group on behalf of NHS England to deliver urgent academic and operational research during the pandemic [e.g., @Curtis2021; @Williamson2020; @Williamson2020].
Analyses can currently run across all patients' full pseudonymised primary care records, with patient-level linkage to various sources of secondary care data.
The OpenSAFELY-TPP is a Trusted Research Environment (TRE) containing the routine clinical data of 23.4m people, approximately 40% of England's population.

Currently QOF reports are published at the end of the financial year, and consist of prevalence rates and indicator achievement rates for clinical areas by NHS geographic breakdowns from region to practice.
We set out to replicate the indicator logic for a variety of QOF clinical indicators in OpenSAFELY-TPP and describe trends monthly over time, before and during the pandemic.
We also describe how the indicators vary between key clinical, regional and demographic subgroups.

High blood pressure is one of the leading risk factors for several diseases (e.g., cardiovascular disease, stroke) worldwide.
Research suggests that delays in the management of high blood pressure are associated with worse clinical outcomes, for example acute cardiovascular events, or death [@Xu2015a].
This report describes the prevalence of people who have a diagnosis of hypertension which has not been subsequently resolved the OpenSAFELY-TPP trusted research environment (TRE).

# Methods

Using OpenSAFELY-TPP, covering 40% of England's population, we have evaluated the QOF Hypertension register (HYP001) between 2019-09-01 and 2022-03-31.
The codelist used can be found here at [OpenSAFELY Codelists](https://codelists.opensafely.org/).

The **study population** for the register was defined following the business rules the (v46).
For each month within the study period, we have calculated the percentage of registered patients with a diagnosis of hypertension which has not been subsequently resolved.
All analytical code and output is available for inspection at the [OpenSAFELY GitHub repository](https://github.com/opensafely/hypertension-sro).

## Business rules

More details about the rules can be found [here](https://digital.nhs.uk/data-and-information/data-collections-and-data-sets/data-collections/quality-and-outcomes-framework-qof/quality-and-outcome-framework-qof-business-rules/qof-business-rules-v46.0-2021-2022-baseline-release).
Dashboards presenting the annual targets of all QOF indicators published by NHSD are available [here](https://digital.nhs.uk/data-and-information/data-tools-and-services/data-services/general-practice-data-hub/quality-outcomes-framework-qof).

### HYP001 (Register)

The description and rules for the Hypertension Register (HYP001, Version: 46.0) are outlined below:

> "Select patients from the specified population who have a diagnosis of hypertension which has not been subsequently resolved."

+-------------+---------------------------------------------------+----------------+-----------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Rule number | Rule                                              | Action if true | Action if false | Rule description or comments                                                                                                                                |
+:============+:==================================================+:===============+:================+:============================================================================================================================================================+
| 1           | If `HYPLAT_DAT` â‰  Null AND If `HYPRES_DAT` = Null | Select         | Reject          | Select patients from the specified population who have a diagnosis of hypertension which has not been subsequently resolved. Reject the remaining patients. |
+-------------+---------------------------------------------------+----------------+-----------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------+

## Codelists

### Hypertension Refsets

+---------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------+----------------------+
| Cluster name                                                                                            | Description                                                                                | SNOMED CT            |
+:========================================================================================================+:===========================================================================================+:=====================+
| [BP_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/bp_cod/)               | Blood pressure (BP) recording codes                                                        | \^999012731000230108 |
+---------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------+----------------------+
| [BPDEC_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/bpdec_cod/)         | Codes indicating the patient has chosen not to have blood pressure procedure               | \^999012611000230106 |
+---------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------+----------------------+
| [HTMAX_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/htmax_cod/)         | Codes for maximal blood pressure (BP) therapy                                              | \^999006651000230109 |
+---------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------+----------------------+
| [HYP_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/hyp_cod/)             | Hypertension diagnosis codes                                                               | \^999006611000230105 |
+---------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------+----------------------+
| [HYPINVITE_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/hypinvite_cod/) | Invite for hypertension care review codes                                                  | \^999012971000230108 |
+---------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------+----------------------+
| [HYPPCADEC_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/hyppcadec_cod/) | Codes indicating the patient has chosen not to receive hypertension quality indicator care | \^999013091000230102 |
+---------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------+----------------------+
| [HYPPCAPU_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/hyppcapu_cod/)   | Codes for hypertension quality indicator care unsuitable for patient                       | \^999013211000230104 |
+---------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------+----------------------+
| [HYPRES_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/hypres_cod/)       | Hypertension resolved codes                                                                | \^999006531000230101 |
+---------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------+----------------------+

### Breakdowns

+---------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------+----------------------+
| Codelist name                                                                                                                                     | Description                                                                                                    | Coding system        |
+:==================================================================================================================================================+:===============================================================================================================+:=====================+
| [Ethnicity](https://www.opencodelists.org/codelist/opensafely/ethnicity/2020-04-27)                                                               | A list of ethnicity codes in use in UK general practice including aggregate grouping at two levels (6 and 16). | CTV3                 |
+---------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------+----------------------+
| [NHS England Care Homes residential status](https://www.opencodelists.org/codelist/opensafely/nhs-england-care-homes-residential-status/3712ef13) | This codelists supports analysis of records of people who may reside in a nursing or care home.                | SNOMED CT            |
+---------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------+----------------------+
| [Learning disability (LD) codes](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/ld_cod/)                                 | The following codes are used to check for a record of learning disability.                                     | SNOMED CT            |
+---------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------+----------------------+

# Results

Note that the scaling of the y-axis scale is different for the total population (0 to 100%) and breakdowns by subgroups (scaling differs across grouping variables to highlight differences between groups).

## HYP001 (Register)

### Total population

```{r fig.width=8, fig.height=6.5}

hyp001_population_pct <- df_measures_hyp001 %>%
  dplyr::filter(group == "population") %>%
  plot_qof_indicator(
    value = value,
    y_scale = "percent",
    legend = "none",
    y_label = "Prevalence (%)",
    set_y_scale_limits = TRUE
  )

hyp001_population_count <- df_measures_hyp001 %>%
  dplyr::filter(group == "population") %>%
  plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    legend = "none",
    y_label = "Prevalence (Count)",
    set_y_scale_limits = TRUE
  )

hyp001_population_pct_count <- (hyp001_population_pct / hyp001_population_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A')

hyp001_population_pct_count

ggplot2::ggsave(filename = "hyp001_population_pct_count.png",
                plot = hyp001_population_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )
```


### Sex

```{r fig.width=8, fig.height=6.5}

hyp001_sex_pct <- df_measures_hyp001 %>%
  dplyr::filter(group == "sex") %>%
  dplyr::mutate(category = factor(category,
    levels = c("F", "M"),
    labels = c("Female", "Male")
  )) %>%
  plot_qof_indicator(
    value = value,
    y_scale = "percent",
    y_label = "Prevalence (%)",
    scale_colour = "brewer_dark2"
  )

hyp001_sex_count <- df_measures_hyp001 %>%
  dplyr::filter(group == "sex") %>%
  dplyr::mutate(category = factor(category,
    levels = c("F", "M"),
    labels = c("Female", "Male")
  )) %>%
  plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    y_label = "Prevalence (Count)",
    scale_colour = "brewer_dark2"
  )

hyp001_sex_pct_count <- (hyp001_sex_pct / hyp001_sex_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

ggplot2::ggsave(filename = "hyp001_sex_pct_count.png",
                plot = hyp001_sex_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )
```

### Age band

```{r fig.width=8, fig.height=6.5}

hyp001_age_band_pct <- df_measures_hyp001 %>%
  dplyr::filter(group == "age_band") %>%
  dplyr::filter(category != "missing") %>%
  plot_qof_indicator(
    value = value,
    y_scale = "percent",
    y_label = "Prevalence (%)"
  )

hyp001_age_band_count <- df_measures_hyp001 %>%
  dplyr::filter(group == "age_band") %>%
  dplyr::filter(category != "missing") %>%
  plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    y_label = "Prevalence (Count)"
  )

hyp001_age_band_pct_count <- (hyp001_age_band_pct / hyp001_age_band_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

hyp001_age_band_pct_count

ggplot2::ggsave(filename = "hyp001_age_band_pct_count.png",
                plot = hyp001_age_band_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )
```

### IMD

```{r fig.width=8, fig.height=6.5}

hyp001_imd_pct <- df_measures_hyp001 %>%
  dplyr::filter(group == "imd") %>%
  dplyr::mutate(category = factor(category,
    levels = c(1:5),
    labels = c("1 - Most deprived", "2", "3", "4", "5 - Least deprived")
  )) %>%
  plot_qof_indicator(
    value = value,
    y_scale = "percent",
    y_label = "Prevalence (%)"
  )

hyp001_imd_count <- df_measures_hyp001 %>%
  dplyr::filter(group == "imd") %>%
  dplyr::mutate(category = factor(category,
    levels = c(1:5),
    labels = c("1 - Most deprived", "2", "3", "4", "5 - Least deprived")
  )) %>%
  plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    y_label = "Prevalence (Count)"
  )

hyp001_imd_pct_count <- (hyp001_imd_pct / hyp001_imd_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

hyp001_imd_pct_count

ggplot2::ggsave(filename = "hyp001_imd_pct_count.png",
                plot = hyp001_imd_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )
```

### Ethnicity

```{r fig.width=8, fig.height=6.5}

hyp001_ethnicity_pct <- df_measures_hyp001 %>%
  dplyr::filter(group == "ethnicity") %>%
  plot_qof_indicator(
    value = value,
    y_scale = "percent",
    y_label = "Prevalence (%)",
    scale_colour = "brewer_set1"
  )

hyp001_ethnicity_count <- df_measures_hyp001 %>%
  dplyr::filter(group == "ethnicity") %>%
  plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    y_label = "Prevalence (Count)",
    scale_colour = "brewer_set1"
  )

hyp001_ethnicity_pct_count <- (hyp001_ethnicity_pct / hyp001_ethnicity_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

hyp001_ethnicity_pct_count

ggplot2::ggsave(filename = "hyp001_ethnicity_pct_count.png",
                plot = hyp001_ethnicity_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )
```

### Region

```{r fig.width=8, fig.height=6.5}

hyp001_region_pct <- df_measures_hyp001 %>%
  dplyr::filter(group == "region") %>%
  plot_qof_indicator(
    value = value,
    y_scale = "percent",
    y_label = "Prevalence (%)",
    scale_colour = "brewer_set1"
  )

hyp001_region_count <- df_measures_hyp001 %>%
  dplyr::filter(group == "region") %>%
  plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    y_label = "Prevalence (Count)",
    scale_colour = "brewer_set1"
  )

hyp001_region_pct_count <- (hyp001_region_pct / hyp001_region_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

hyp001_region_pct_count

ggplot2::ggsave(filename = "hyp001_region_pct_count.png",
                plot = hyp001_region_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )
```

### Learning disability

```{r fig.width=8, fig.height=6.5}

hyp001_learning_disability_pct <- df_measures_hyp001 %>%
  dplyr::filter(group == "learning_disability") %>%
  dplyr::mutate(category = factor(category,
    levels = c(TRUE, FALSE),
    labels = c(
      "Record of learning disability",
      "No record of learning disability"
    )
  )) %>%
  plot_qof_indicator(
    value = value,
    y_scale = "percent",
    y_label = "Prevalence (%)",
    scale_colour = "brewer_dark2"
  )

hyp001_learning_disability_count <- df_measures_hyp001 %>%
  dplyr::filter(group == "learning_disability") %>%
  dplyr::mutate(category = factor(category,
    levels = c(TRUE, FALSE),
    labels = c(
      "Record of learning disability",
      "No record of learning disability"
    )
  )) %>%
  plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    y_label = "Prevalence (Count)",
    scale_colour = "brewer_dark2"
  )

hyp001_learning_disability_pct_count <- (hyp001_learning_disability_pct / hyp001_learning_disability_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

hyp001_learning_disability_pct_count

ggplot2::ggsave(filename = "hyp001_learning_disability_pct_count.png",
                plot = hyp001_learning_disability_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )
```

### Care home status

```{r fig.width=8, fig.height=6.5}

hyp001_care_home_pct <- df_measures_hyp001 %>%
  dplyr::filter(group == "care_home") %>%
  dplyr::mutate(category = factor(category,
    levels = c(TRUE, FALSE),
    labels = c(
      "Record of positive care home status",
      "No record of positive care home status"
    )
  )) %>%
  plot_qof_indicator(
    value = value,
    y_scale = "percent",
    y_label = "Prevalence (%)",
    scale_colour = "brewer_dark2"
  )

hyp001_care_home_count <- df_measures_hyp001 %>%
  dplyr::filter(group == "care_home") %>%
  dplyr::mutate(category = factor(category,
    levels = c(TRUE, FALSE),
    labels = c(
      "Record of positive care home status",
      "No record of positive care home status"
    )
  )) %>%
  plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    y_label = "Prevalence (Count)",
    scale_colour = "brewer_dark2"
  )

hyp001_care_home_pct_count <- (hyp001_care_home_pct / hyp001_care_home_count) +
  patchwork::plot_layout(guides = 'collect') &
  patchwork::plot_annotation(tag_levels = 'A') &
  ggplot2::theme(legend.position = "top")

hyp001_care_home_pct_count

ggplot2::ggsave(filename = "hyp001_care_home_pct_count.png",
                plot = hyp001_care_home_pct_count,
                width = 8,
                height = 6.5, 
                units = "in",
                path = here::here("released_outputs", "figures")
                )
```

# Discussion

-   TODO

# References

