---
title: "QOF - Hypertension"
subtitle: "Indicators: HYP001 (Register)"
# bibliography: references.bib
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: hide
---

```{r setup, include=FALSE}
# Set Rmd options ----
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Load packages ----
library(ggplot2)
library(magrittr)
library(dplyr)
library(tidyr)
library(here)
library(knitr)
library(readr)
library(fs)
library(purrr)
library(stringr)
library(gt)
library(ggrepel)
library(fs)

# Load plotting function
source(here::here("lib", "functions", "fun_plot.R"))

# Create directory if it doesnt exist
fs::dir_create(here::here("output", "notebooks"))
```

```{r load-data, include=FALSE}
# Get file names and path ----
df_measures_hyp001 <- readr::read_csv(here::here("output", "measures", "measures_hyp001.csv"))
list_nhs_financial_years <- unique(df_measures_hyp001$date[lubridate::month(df_measures_hyp001$date) == 4])
```
# Introduction

> *The Quality and Outcomes Framework (QOF) is a voluntary annual reward and incentive programme for all GP practices in England* ([NHSD, 2021a](https://qof.digital.nhs.uk/)). 
> *The objective of the Quality and Outcomes Framework (QOF) is to improve the quality of care patients are given by rewarding practices for the quality of care they provide to their patients, based on a number of indicators across a range of key areas of clinical care and public health.*
> *QOF participation by GP practices is very high, with 96.7% of practices participating in the 2020/21 publication* ([NHSD, 2021b](https://digital.nhs.uk/data-and-information/publications/statistical/quality-and-outcomes-framework-achievement-prevalence-and-exceptions-data/2020-21)).

OpenSAFELY is a secure analytics platform for electronic patient records built by our group on behalf of NHS England to deliver urgent academic and operational research during the pandemic (e.g., [Curtis et al., 2021](https://bjgp.org/content/72/714/e63); [Williamson et al., 2020](https://www.nature.com/articles/s41586-020-2521-4)). 
Analyses can currently run across all patients' full pseudonymised primary care records, with patient-level linkage to various sources of secondary care data. 
The OpenSAFELY-TPP is a Trusted Research Environment (TRE) containing the routine clinical data of 23.4m people, approximately 40% of England's population.

Currently QOF reports are published at the end of the financial year, and consist of prevalence rates and indicator achievement rates for clinical areas by NHS geographic breakdowns from region to practice.
We set out to replicate the indicator logic for a variety of QOF clinical indicators in OpenSAFELY-TPP and describe trends monthly over time, before and during the pandemic.
We also describe how the indicators vary between key clinical, regional and demographic subgroups.

High blood pressure is one of the leading risk factors for several diseases (e.g., cardiovascular disease, stroke) worldwide. 
Research suggests that delays in the management of high blood pressure are associated with worse clinical outcomes, for example acute cardiovascular events, or death ([Xu et al., 2015](https://www.bmj.com/content/350/bmj.h158)).
This report describes the prevalence of people who have a diagnosis of hypertension which has not been subsequently resolved the OpenSAFELY-TPP trusted research environment (TRE). 

# Methods

Using OpenSAFELY-TPP, covering 40% of England's population, we have evaluated the QOF Hypertension register (HYP001) between 2019-09-01 and 2022-03-31.
The codelist used can be found here at [OpenSAFELY Codelists](https://codelists.opensafely.org/).

The **study population** for the register was defined following the business rules the (v46).
For each month within the study period, we have calculated the percentage of registered patients with a diagnosis of hypertension which has not been subsequently resolved.
All analytical code and output is available for inspection at the [OpenSAFELY GitHub repository](https://github.com/opensafely/hypertension-sro).

## Business rules

More details about the rules can be found [here](https://digital.nhs.uk/data-and-information/data-collections-and-data-sets/data-collections/quality-and-outcomes-framework-qof/quality-and-outcome-framework-qof-business-rules/qof-business-rules-v46.0-2021-2022-baseline-release).
Dashboards presenting the annual targets of all QOF indicators published by NHSD are available [here](https://digital.nhs.uk/data-and-information/data-tools-and-services/data-services/general-practice-data-hub/quality-outcomes-framework-qof).

### HYP001 (Register)

The description and rules for the Hypertension Register (HYP001, Version: 46.0) are outlined below:

> "Select patients from the specified population who have a diagnosis of hypertension which has not been subsequently resolved."

| Rule number | Rule | Action if true | Action if false | Rule description or comments |
| :---------- | :--- | :------------- | :-------------- | :--------------------------- |
| 1 | If `HYPLAT_DAT` ≠ Null AND If `HYPRES_DAT` = Null | Select | Reject | Select patients from the specified population who have a diagnosis of hypertension which has not been subsequently resolved. Reject the remaining patients. |

## Codelists

### Hypertension Refsets 

| Cluster name | Description | SNOMED CT |
|:---|:---|:---|
| [BP_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/bp_cod/) | Blood pressure (BP) recording codes | ^999012731000230108 | 
| [BPDEC_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/bpdec_cod/) | Codes indicating the patient has chosen not to have blood pressure procedure | ^999012611000230106 | 
| [HTMAX_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/htmax_cod/) | Codes for maximal blood pressure (BP) therapy | ^999006651000230109 | 
| [HYP_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/hyp_cod/) | Hypertension diagnosis codes | ^999006611000230105 | 
| [HYPINVITE_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/hypinvite_cod/) | Invite for hypertension care review codes | ^999012971000230108 | 
| [HYPPCADEC_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/hyppcadec_cod/) | Codes indicating the patient has chosen not to receive hypertension quality indicator care | ^999013091000230102 | 
| [HYPPCAPU_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/hyppcapu_cod/) | Codes for hypertension quality indicator care unsuitable for patient | ^999013211000230104 | 
| [HYPRES_COD](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/hypres_cod/) | Hypertension resolved codes | ^999006531000230101 | 

### Breakdowns

| Codelist name | Description | Coding system |
|:---|:---|:---|
| [Ethnicity](https://www.opencodelists.org/codelist/opensafely/ethnicity/2020-04-27) | A list of ethnicity codes in use in UK general practice including aggregate grouping at two levels (6 and 16). | CTV3 |
| [NHS England Care Homes residential status](https://www.opencodelists.org/codelist/opensafely/nhs-england-care-homes-residential-status/3712ef13) | This codelists supports analysis of records of people who may reside in a nursing or care home. | SNOMED CT |
| [Learning disability (LD) codes](https://www.opencodelists.org/codelist/nhsd-primary-care-domain-refsets/ld_cod/) | The following codes are used to check for a record of learning disability. | SNOMED CT |

# Results

Note that the scaling of the y-axis scale is different for the total population (0 to 100%) and breakdowns by subgroups (scaling differs across grouping variables to highlight differences between groups).

## HYP001 (Register)

### Total population

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "population") %>%
  plot_qof_indicator(
    value = value,
    y_scale = "percent",
    geom_segment = TRUE,
    legend = "none",
    y_label = "Prevalence (%)",
    set_y_scale_limits = TRUE)

```

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "population") %>%
  plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    legend = "none",
    x_scale_date_breaks = "4 months",
    geom_segment = TRUE,
    y_label = "Prevalence (Count)",
    set_y_scale_limits = TRUE)

```

### Sex

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "sex") %>%
  dplyr::mutate(category = factor(category,
    levels = c("F", "M"),
    labels = c("Female", "Male")
  )) %>%
  plot_qof_indicator(
    value = value,
    y_scale = "percent",
    y_label = "Prevalence (%)") +
  scale_colour_brewer(palette = "Dark2")

```

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "sex") %>%
  dplyr::mutate(category = factor(category,
                                  levels = c("F", "M"),
                                  labels = c("Female", "Male"))) %>%
  plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    x_scale_date_breaks = "4 months",
    y_label = "Prevalence (Count)") +
  scale_colour_brewer(palette = "Dark2")

```

### Age band

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "age_band") %>%
  dplyr::filter(category != "missing") %>%
  plot_qof_indicator(
    value = value,
    y_scale = "percent",
    y_label = "Prevalence (%)")

```

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "age_band") %>%
  dplyr::filter(category != "missing") %>%
    plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    x_scale_date_breaks = "4 months",
    y_label = "Prevalence (Count)")

```

### IMD

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "imd") %>%
  dplyr::mutate(category = factor(category,
    levels = c(1:5),
    labels = c("1 - Most deprived", "2", "3", "4", "5 - Least deprived")
  )) %>%
  plot_qof_indicator(
    value = value,
    y_scale = "percent",
    y_label = "Prevalence (%)")

```

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "imd") %>%
  dplyr::mutate(category = factor(category,
    levels = c(1:5),
    labels = c("1 - Most deprived", "2", "3", "4", "5 - Least deprived")
  )) %>% 
  plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    x_scale_date_breaks = "4 months",
    y_label = "Prevalence (Count)")

```

### Ethnicity

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "ethnicity") %>%
    plot_qof_indicator(
    value = value,
    y_scale = "percent",
    x_scale_date_breaks = "4 months",
    y_label = "Prevalence (%)") +
  scale_colour_brewer(palette = "Dark2")
```

```{r fig.width=8, fig.height=4}
df_measures_hyp001 %>%
  dplyr::filter(group == "ethnicity") %>%
  plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    x_scale_date_breaks = "4 months",
    y_label = "Prevalence (Count)") +
  scale_colour_brewer(palette = "Dark2")
```

### Region

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "region") %>%
    plot_qof_indicator(
    value = value,
    y_scale = "percent",
    x_scale_date_breaks = "4 months",
    y_label = "Prevalence (%)") +
  scale_colour_brewer(palette = "Set1")
```

```{r fig.width=8, fig.height=4}
df_measures_hyp001 %>%
  dplyr::filter(group == "region") %>%
  plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    x_scale_date_breaks = "4 months",
    y_label = "Prevalence (Count)") +
  scale_colour_brewer(palette = "Set1")
```

### Learning disability

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "learning_disability") %>%
  dplyr::mutate(category = factor(category,
    levels = c(TRUE, FALSE),
    labels = c(
      "Record of learning disability",
      "No record of learning disability"
    )
  )) %>%
      plot_qof_indicator(
    value = value,
    y_scale = "percent",
    x_scale_date_breaks = "4 months",
    y_label = "Prevalence (%)") +
  scale_colour_brewer(palette = "Dark2")
```

```{r fig.width=8, fig.height=4}
df_measures_hyp001 %>%
  dplyr::filter(group == "learning_disability") %>%
  dplyr::mutate(category = factor(category,
    levels = c(TRUE, FALSE),
    labels = c(
      "Record of learning disability",
      "No record of learning disability"
    )
  )) %>%
  plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    x_scale_date_breaks = "4 months",
    y_label = "Prevalence (Count)") +
  scale_colour_brewer(palette = "Dark2")
```

### Care home status

```{r fig.width=8, fig.height=4}

df_measures_hyp001 %>%
  dplyr::filter(group == "care_home") %>%
  dplyr::mutate(category = factor(category,
    levels = c(TRUE, FALSE),
    labels = c(
      "Record of positive care home status",
      "No record of positive care home status"
    )
  )) %>%
      plot_qof_indicator(
    value = value,
    y_scale = "percent",
    x_scale_date_breaks = "4 months",
    y_label = "Prevalence (%)") +
  scale_colour_brewer(palette = "Dark2")
```

```{r fig.width=8, fig.height=4}
df_measures_hyp001 %>%
  dplyr::filter(group == "care_home") %>%
  dplyr::mutate(category = factor(category,
    levels = c(TRUE, FALSE),
    labels = c(
      "Record of positive care home status",
      "No record of positive care home status"
    )
  )) %>%
  plot_qof_indicator(
    value = hypertension,
    y_scale = "count",
    x_scale_date_breaks = "4 months",
    y_label = "Prevalence (Count)") +
  scale_colour_brewer(palette = "Dark2")
```

# Discussion

- TODO

# References 

1. Curtis HJ, MacKenna B, Croker R, Inglesby P, Walker AJ, Morley J, et al. OpenSAFELY NHS Service Restoration Observatory 1: describing trends and variation in primary care clinical activity for 23.3 million patients in England during the first wave of COVID-19. Br J Gen Pract [Internet]. 2021 Sep 20 [cited 2021 Oct 5]; Available from: https://bjgp.org/content/early/2021/09/24/BJGP.2021.0380
1. NHS Digital. QOF 2020-21 results. 2021a. https://qof.digital.nhs.uk/
1. NHS Digital. Quality and Outcomes Framework, 2020-21 Official Statistics. 2021b. https://digital.nhs.uk/data-and-information/publications/statistical/quality-and-outcomes-framework-achievement-prevalence-and-exceptions-data/2020-21
1. Williamson EJ, Walker AJ, Bhaskaran K, Bacon S, Bates C, Morton CE, et al. Factors associated with COVID-19-related death using OpenSAFELY. Nature. 2020 Aug;584(7821):430–6. https://www.nature.com/articles/s41586-020-2521-4
1. Xu W, Goldberg SI, Shubina M, Turchin A. Optimal systolic blood pressure target, time to intensification, and time to follow-up in treatment of hypertension: population based retrospective cohort study. BMJ. 2015 Feb 5;350:h158. https://www.bmj.com/content/350/bmj.h158
