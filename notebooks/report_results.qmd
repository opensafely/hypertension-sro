This notebook creates the figures and tables for the manuscript.

# Load packages and function

```{r}

library(tidyverse)
library(lubridate)
library(here)
library(scales)
library(janitor)
library(patchwork)
library(gt)

```


```{r}
# Load reporting function
source(here::here("lib", "functions", "funs_report_results.R"))
```

# Load data

```{r}

df_deciles_bp_hyp_practice <- read_csv(here("released_outputs/deciles/deciles_bp_hyp_practice.csv"))
df_measures_bp_hyp <- read_csv(here("released_outputs/measures/df_measures_bp_hyp.csv"))

df_deciles_bp_hyp_practice <- df_deciles_bp_hyp_practice |>
  rename(category = percentile) |>
  mutate(variable = "decile",
         group = "practice_level_decile",
         category = as.character(category)) |>
  relocate(indicator, date, variable, group, category, value)

df_measures_bp_hyp <- df_measures_bp_hyp |> bind_rows(df_deciles_bp_hyp_practice)|>
  arrange(indicator, date, variable, group, category)

df_deciles_bp_hyp_practice |>
  group_by(indicator) |>
  count()

df_measures_bp_hyp 

df_measures_bp_hyp <- df_measures_bp_hyp |>
  filter(date < "2022-04-01")

```

# Minimum & maximum value

```{r}

df <- summary_report_min_max(df = df_measures_bp_hyp,
                             filter_group = "population",
                             filter_variable = "pct")

df      

df_measures_bp_hyp |>
  # filter(month(date) == 3) |>
  filter(group == "population") |>
  group_by(indicator, variable) |>
  slice_max(value, n = 2) |>
  filter(variable == "pct")

df_measures_bp_hyp
```

# First & last date

```{r}

df_measures_bp_hyp |>
  filter(group == "population") |>
  group_by(indicator, variable) |>
  slice_min(date, n = 1) |>
  filter(variable == "pct")

df_measures_bp_hyp |>
  filter(group == "population") |>
  group_by(indicator, variable) |>
  slice_max(date, n = 1) |>
  filter(variable == "pct")

```

# Report national median
```{r}

report_national_median(df_measures_bp_hyp, filter_date = "2021-03-01")

```

# Report values for all categories in one group at particulat date

```{r}

unique(df_measures_bp_hyp$variable)
unique(df_measures_bp_hyp$group)
unique(df_measures_bp_hyp$category)

report_group_pct(df_measures_bp_hyp, filter_group = "region", filter_category = NULL, filter_date = "2021-03-01")


```

# Report population values at a particular date

```{r}

df_measures_bp_hyp |>
  filter(date == "2021-03-01") |>
  filter(variable == "pct") |>
  filter(group == "population")

```